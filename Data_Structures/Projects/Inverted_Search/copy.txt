#include "invsearch.h"

int main(int argc, char* argv[])
{
    filenames_t* head = NULL;               // Head pointer for linked list of filenames
    db_status status = db_empty;            // Track database status (empty, created, updated)
    hashtable_t hash_table[28];             // Hash table with 28 slots (aâ€“z, digits, special chars)

    // Initialize hash table
    for (int i = 0; i < 28; i++)
    {
        hash_table[i].index = i;
        hash_table[i].h_link = NULL;
    }

    // Validate command-line arguments and files
    if (read_and_validate(argc, argv, &head) == FAILURE)
    {
        printf("\033[1;31mCommand Line Validations Failed\033[0m\n");
        return FAILURE;
    }

    int choice;                             // Variable to store user menu choice

    while (1)                               // Infinite loop for menu-driven program
    {
        // Print main menu
        printf("\033[1;33m+______________________+\n");
        printf("|      Main Menu       |\n");
        printf("|======================|\n");
        printf("| 1.  Create Database  |\n");
        printf("| 2.  Display Database |\n");
        printf("| 3.  Search Database  |\n");
        printf("| 4.  Update Database  |\n");
        printf("| 5.  Save Database    |\n");
        printf("| 6.  Exit             |\n");
        printf("+______________________+\n");
        printf("\033[1;36mEnter the Choice : ");
        printf("\033[0m");

        scanf("%d", &choice);               // Read user choice

        switch (choice)
        {
        case 1: // Create Database
            if (status == db_created)
            {
                printf("\033[1;31mError :Database Already Created\033[0m\n");
                return FAILURE;
            }
            else if (status == db_updated)
            {
                printf("\033[1;31mError :Cannot Create After the Database is Updated\033[0m\n");
                return FAILURE;
            }
            else
            {
                if (create_database(head, hash_table) == SUCCESS)
                {
                    printf("\033[1;32mDatabase Created Successfully\033[0m\n");
                    status = db_created;
                }
            }
            break;

        case 2: // Display Database
            if (status == db_empty)
            {
                printf("\033[1;31mDatabase Not Created Yet. Please Create Database First\033[0m\n");
            }
            else if (display_database(hash_table) == FAILURE)
            {
                printf("\033[1;31mNothing to Display in Database\033[0m");
                return FAILURE;
            }
            break;

        case 3: // Search Database
            if (status == db_empty)
            {
                printf("\033[1;31mError :Database is Not Even Created. Please Create Database First\033[0m\n");
                return FAILURE;
            }
            else
            {
                char search_word[WORD_SIZE]; // Buffer for search word
                printf("\033[1;36mEnter Word to Search: \033[0m");
                scanf("%s", search_word);
                if (search_database(hash_table, search_word) == DATA_NOT_FOUND)
                {
                    printf("\033[1;31mWord Not Found in Database\033[0m\n");
                }
            }
            break;

        case 4: // Update Database
            if (status == db_empty)
            {
                if (update_database(&head, hash_table) == SUCCESS)
                {
                    status = db_updated;
                    printf("\033[1;32mDatabase Updated Successfully\033[0m\n");
                }
                else
                {
                    printf("\033[1;31mNo Previous Database File Found. Please Create Database File First\033[0m\n");
                }
            }
            else if (status == db_updated)
            {
                printf("\033[1;31mWe Cannot Update an Updated Database\033[0m\n");
            }
            else if (status == db_created)
            {
                printf("\033[1;31mUpdate is Possible Before Database Create\033[0m\n");
            }
            break;

        case 5: // Save Database
            if (save_database(hash_table) == SUCCESS)
            {
                printf("\033[1;32mDatabase Saved Successfully\033[0m\n");
            }
            else if (save_database(hash_table) == INVALID)
            {
                return FAILURE;
            }
            else
            {
                printf("\033[1;31mFailed to Save Database\033[0m\n");
            }
            break;

        case 6: // Exit
            printf("\033[1;33mExiting........\033[0m\n");
            return EXIT;
            break;

        default: // Invalid choice
            printf("\033[1;31mInvalid Choice Entered, Try Again\033[0m\n");
        }
    }
}